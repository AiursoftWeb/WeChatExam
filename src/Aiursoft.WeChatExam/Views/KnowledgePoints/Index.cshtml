@using System.Net
@model Aiursoft.WeChatExam.Models.KnowledgePointsViewModels.IndexViewModel

@functions {
    string GetSafeId(Guid id) => "KP_" + id.ToString("N");

    string GetKpNodeLabel(Aiursoft.WeChatExam.Entities.KnowledgePoint kp, bool isRoot, string categories)
    {
        var badge = isRoot ? "Root" : "Child";
        var title = WebUtility.HtmlEncode(kp.Title);
        var catLine = string.IsNullOrEmpty(categories) ? "" : $"<div style='font-size:11px;color:rgb(100,100,100);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis'>{WebUtility.HtmlEncode(categories)}</div>";
        var label = $"<div style='width:180px;padding:8px;text-align:left'><div style='font-weight:700;font-size:14px;margin-bottom:4px'>{title}</div><span style='font-size:11px;background:rgb(230,230,230);padding:1px 6px;border-radius:4px;color:rgb(68,68,68);font-weight:500'>{badge}</span>{catLine}</div>";
        return $"\"{label}\"";
    }
}

@* Standard page title for consistency. *@
<h1 class="h3 mb-3">@Localizer["KnowledgePoints"]</h1>

<div class="row">
    <div class="col-12">
        <div class="tab">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" href="#list" data-bs-toggle="tab" role="tab" aria-selected="true">
                        <i class="align-middle me-1" data-lucide="list"></i> @Localizer["List View"]
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" href="#tree" data-bs-toggle="tab" role="tab" aria-selected="false" id="tree-tab">
                        <i class="align-middle me-1" data-lucide="share-2"></i> @Localizer["Visual Tree"]
                    </a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="list" role="tabpanel">
                    <div class="card border-top-0">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">@Localizer["KnowledgePoint List"]</h5>
                            <a asp-action="Create" class="btn btn-primary btn-sm">
                                <i class="align-middle me-2" data-lucide="plus-circle"></i> @Localizer["Add KnowledgePoint"]
                            </a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>@Localizer["Title"]</th>
                                        <th>@Localizer["Parent"]</th>
                                        <th style="width: 150px;">@Localizer["Actions"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var knowledgePoint in Model.RootKnowledgePoints)
                                    {
                                        @await Html.PartialAsync("_KnowledgePointRow", knowledgePoint)
                                    }
                                    @if (!Model.RootKnowledgePoints.Any())
                                    {
                                        <tr>
                                            <td colspan="3" class="text-center text-muted py-4">
                                                @Localizer["No knowledgePoints found"]
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="tree" role="tabpanel">
                    <div class="card border-top-0">
                        <div class="card-body overflow-auto">
                            <script id="mermaid-source" type="text/template">
                                graph TD
                                classDef rootNode fill:#E3F2FD,stroke:#1565C0,stroke-width:2px,rx:10,ry:10
                                classDef childNode fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px,rx:10,ry:10

                                @{
                                    foreach (var kp in Model.KnowledgePoints)
                                    {
                                        var isRoot = kp.ParentId == null;
                                        var cssClass = isRoot ? "rootNode" : "childNode";
                                        var categories = string.Join(", ", kp.CategoryKnowledgePoints.Select(ck => ck.Category.Title));
                                        <text>@(GetSafeId(kp.Id))(@Html.Raw(GetKpNodeLabel(kp, isRoot, categories))):::@cssClass
</text>
                                        <text>click @GetSafeId(kp.Id) href "/KnowledgePoints/Details/@kp.Id"
</text>
                                        if (kp.ParentId != null)
                                        {
                                            <text>@GetSafeId(kp.ParentId.Value) --> @GetSafeId(kp.Id)
</text>
                                        }
                                    }
                                }

                                @if (!Model.KnowledgePoints.Any())
                                {
                                    @:NoData["@(Localizer["No knowledgePoints found"])"]
                                }
                            </script>
                            <div id="mermaid-output"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: false,
        securityLevel: 'loose',
        theme: 'base',
        themeVariables: {
            fontFamily: 'Inter, system-ui, sans-serif',
            fontSize: '14px',
            lineColor: '#607D8B'
        },
        flowchart: {
            htmlLabels: true,
            curve: 'basis',
            useMaxWidth: false
        }
    });

    let rendered = false;

    async function renderMermaid() {
        if (rendered) return;
        rendered = true;
        const source = document.getElementById('mermaid-source').innerHTML.trim();
        const output = document.getElementById('mermaid-output');
        try {
            const { svg } = await mermaid.render('mermaid-graph', source);
            output.innerHTML = svg;
        } catch (e) {
            output.innerHTML = '<p class="text-danger">Failed to render tree: ' + e.message + '</p>';
        }
    }

    // Render when tree tab is shown (tab must be visible for foreignObject dimension measurement)
    const treeTab = document.getElementById('tree-tab');
    if (treeTab) {
        treeTab.addEventListener('shown.bs.tab', renderMermaid);
    }
</script>

<style>
    #mermaid-output {
        display: flex;
        justify-content: center;
        min-height: 400px;
        background-color: #fff;
    }

    #mermaid-output svg {
        max-width: 100%;
        height: auto;
        width: auto !important;
    }
</style>
