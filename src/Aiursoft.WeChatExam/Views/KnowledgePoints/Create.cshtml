@model Aiursoft.WeChatExam.Models.KnowledgePointsViewModels.CreateViewModel

<h1 class="h3 mb-3">@Localizer["Create KnowledgePoint"]</h1>
<form asp-action="Create" method="post">
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
    <div class="mb-3">
        <label asp-for="Title" class="form-label">@Localizer["Title"]</label>
        <input asp-for="Title" class="form-control" />
        <span asp-validation-for="Title" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Content" class="form-label">@Localizer["Content"]</label>
        <input asp-for="Content" class="form-control" />
        <span asp-validation-for="Content" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="ParentId" class="form-label">@Localizer["Parent KnowledgePoint"]</label>
        <select asp-for="ParentId" class="form-select">
            <option value="">@Localizer["Top Level"]</option>
            @foreach (var parent in Model.AvailableParents)
            {
                <option value="@parent.Id">@parent.Title</option>
            }
        </select>
        <span asp-validation-for="ParentId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="SelectedCategoryIds" class="form-label">@Localizer["Associated Categories"]</label>
        <select asp-for="SelectedCategoryIds" class="form-select" multiple style="height: 200px">
            @foreach (var category in Model.AvailableCategories)
            {
                <option value="@category.Id">@category.Title</option>
            }
        </select>
        <div class="form-text">@Localizer["Hold Ctrl (Windows) or Command (Mac) to select multiple options."]</div>
        <span asp-validation-for="SelectedCategoryIds" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">@Localizer["Associated Questions"]</label>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">@Localizer["MTQL Question Finder"]</h5>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-4">
                        <select id="type-filter" asp-items="Model.QuestionTypeOptions" class="form-select">
                            <option value="">@Localizer["All Types"]</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="mtql-input" class="form-control" placeholder='@Localizer["Enter MTQL query (e.g. content:\"math\")"]' />
                            <button class="btn btn-outline-secondary" type="button" onclick="searchQuestions()">
                                <i class="align-middle" data-lucide="search"></i> @Localizer["Search"]
                            </button>
                        </div>
                    </div>
                </div>
                <div id="search-results-container" class="list-group overflow-auto" style="max-height: 300px;">
                    <div class="list-group-item text-muted">@Localizer["Search results will appear here..."]</div>
                </div>
                <div class="mt-2 text-end">
                    <button type="button" class="btn btn-sm btn-success" onclick="addSelectedQuestions()">
                        <i class="align-middle" data-lucide="plus"></i> @Localizer["Add Selected"]
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <label class="form-label">@Localizer["Selected Questions"]</label>
            <div id="selected-questions-container" class="list-group">
                @foreach (var question in Model.AvailableQuestions)
                {
                    var content = question.Content.Length > 100 ? question.Content.Substring(0, 100) + "..." : question.Content;
                    <div class="list-group-item d-flex justify-content-between align-items-center" data-question-id="@question.Id">
                        <span>@content</span>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion('@question.Id')">
                            <i class="align-middle" data-lucide="trash-2"></i>
                        </button>
                        <input type="hidden" name="SelectedQuestionIds" value="@question.Id" />
                    </div>
                }
            </div>
        </div>
        <span asp-validation-for="SelectedQuestionIds" class="text-danger"></span>
    </div>

    @* ReSharper disable once Razor.SectionNotResolved *@
    @section scripts {
        <script>
            function searchQuestions() {
                var mtql = document.getElementById('mtql-input').value;
                var type = document.getElementById('type-filter').value;
                var container = document.getElementById('search-results-container');
                container.innerHTML = '<div class="list-group-item">@Localizer["Searching..."]</div>';

                fetch(`/Questions/Search?mtql=${encodeURIComponent(mtql)}&questionType=${type}`)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        container.innerHTML = '';
                        if (data.length === 0) {
                            container.innerHTML = '<div class="list-group-item">@Localizer["No questions found."]</div>';
                            return;
                        }
                        data.forEach(q => {
                            var item = document.createElement('label');
                            item.className = 'list-group-item d-flex gap-2 align-items-center';
                            item.innerHTML = `
                                <input class="form-check-input flex-shrink-0" type="checkbox" value="${q.id}" data-content="${q.content}">
                                <span class="badge bg-info">${q.questionType}</span>
                                <span>${q.content}</span>
                            `;
                            container.appendChild(item);
                        });
                    })
                    .catch(error => {
                        container.innerHTML = `<div class="list-group-item text-danger">@Localizer["Error:"] ${error.message}</div>`;
                    });
            }

            function addSelectedQuestions() {
                var searchContainer = document.getElementById('search-results-container');
                var selectedContainer = document.getElementById('selected-questions-container');
                var checkboxes = searchContainer.querySelectorAll('input[type="checkbox"]:checked');

                checkboxes.forEach(cb => {
                    var id = cb.value;
                    var content = cb.getAttribute('data-content');

                    if (!selectedContainer.querySelector(`div[data-question-id="${id}"]`)) {
                        var item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.setAttribute('data-question-id', id);
                        item.innerHTML = `
                            <span>${content}</span>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion('${id}')">
                                 <i class="align-middle" data-lucide="trash-2"></i>
                            </button>
                            <input type="hidden" name="SelectedQuestionIds" value="${id}" />
                        `;
                        selectedContainer.appendChild(item);
                    }
                    cb.checked = false;
                });
                lucide.createIcons();
            }

            function removeQuestion(id) {
                var container = document.getElementById('selected-questions-container');
                var item = container.querySelector(`div[data-question-id="${id}"]`);
                if (item) {
                    item.remove();
                }
            }
            
            // Allow pressing Enter in search input
            document.getElementById('mtql-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchQuestions();
                }
            });
        </script>
    }
    <button type="submit" class="btn btn-primary">
        <i class="align-middle me-2" data-lucide="plus-circle"></i> @Localizer["Create"]
    </button>
    <a asp-action="Index" class="btn btn-light">@Localizer["Back to List"]</a>
</form>
